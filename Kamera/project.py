import numpy as np
import matplotlib.pyplot as plt
from utils import load_coeffs

def project_points(data : dict, calib_params : dict, newmtx : bool = False) -> np.ndarray:
    # 1. create point matrix
    # initialize
    num_obj = data['header']['objects']
    points = data['detected_points']
    point_mtx = np.zeros((3, num_obj))
    cam_mtx = calib_params['mtx']
    new_mtx = calib_params['newmtx']
    # fill matrix
    point_mtx[0, :] = np.array([coords['x'] for coords in points.values()])
    point_mtx[1, :] = np.array([coords['z'] for coords in points.values()])
    point_mtx[2, :] = np.array([coords['y'] for coords in points.values()])
    # 2. project points (X,Y,Z) -> (u,v)
    proj = (cam_mtx @ point_mtx)
    proj[:2, :] /= point_mtx[2,:]
    if newmtx:
        newp = (new_mtx @ point_mtx)
        newp[:2, :] /= point_mtx[2,:]
        return proj, newp
    return proj

if __name__ == '__main__':
    data = {
        'header': {
        'magic': b'\x02\x01\x04\x03\x06\x05\x08\x07', 
        'version': 3060000, 
        'length': 704, 
        'platform': 106843, 
        'number': 2, 
        'time': 1725600548, 
        'objects': 5, 
        'blocks': 3, 
        'subframe': 0
        }, 
        'detected_points': 
        {
            '0,0': 
            {
                'v': 0.0, 
                'x': -0.015771405771374702, 
                'y': 0.2611609399318695, 
                'z': 0.0
            }, 
            '1,1': 
            {
                'v': 0.0, 
                'x': 0.6308562755584717, 
                'y': 0.49583205580711365, 
                'z': 0.3417138159275055
            }, 
            '2,2': 
            {
                'v': 0.0, 
                'x': -0.2115996927022934, 
                'y': 0.9761617183685303, 
                'z': 0.09068558365106583
            }, 
            '3,3': 
            {
                'v': 0.0, 
                'x': 0.5086278915405273, 
                'y': 4.697953701019287, 
                'z': 3.051767349243164
            }, 
            '4,4': 
            {
                'v': 0.0, 
                'x': 0.20502828061580658, 
                'y': 6.255279541015625, 
                'z': 2.665367603302002
            }
        }, 
        'side_info': 
        {
            '0,0': 
            {
                'snr': 179, 
                'noise': 1045
            }, 
            '1,1': 
            {
                'snr': 185, 
                'noise': 885
            }, 
            '2,2': 
            {
                'snr': 159, 
                'noise': 880
            }, 
            '3,3': 
            {
                'snr': 246, 
                'noise': 805
            }, 
            '4,4': 
            {
                'snr': 180, 
                'noise': 854
            }
        }, 
        'range_profile': 
        [
            55.18359375, 58.3359375, 57.24609375, 51.71484375, 51.87890625, 57.08203125, 61.21875, 60.99609375, 57.15234375, 
            52.83984375, 52.48828125, 51.375, 49.83984375, 51.12890625, 54.52734375, 53.75390625, 51.8203125, 52.4765625, 
            53.2265625, 50.5078125, 53.5546875, 50.953125, 49.9921875, 51.99609375, 51.9609375, 50.26171875, 45.19921875, 
            44.40234375, 44.3203125, 44.109375, 42.515625, 41.9765625, 41.484375, 42.9375, 46.32421875, 48.515625, 47.015625, 
            43.9453125, 42.03515625, 41.21484375, 38.671875, 40.5, 38.15625, 45.15234375, 46.921875, 44.9765625, 40.81640625, 
            39.99609375, 43.7109375, 44.19140625, 42.9609375, 45.15234375, 44.953125, 43.8984375, 46.04296875, 46.18359375, 
            44.75390625, 42.66796875, 43.125, 42.59765625, 42.5390625, 41.1328125, 45.17578125, 43.60546875, 42.515625, 46.3125, 
            49.21875, 48.66796875, 44.23828125, 42.41015625, 44.19140625, 44.54296875, 42.1875, 42.890625, 42.46875, 41.51953125, 
            40.79296875, 42.234375, 43.59375, 43.25390625, 42.5625, 42.421875, 41.33203125, 40.21875, 47.6484375, 49.58203125, 
            49.171875, 47.34375, 42.1640625, 44.44921875, 43.60546875, 41.296875, 44.6953125, 45.3515625, 44.40234375, 43.18359375, 
            41.90625, 41.109375, 45.99609375, 48.8203125, 49.01953125, 46.7578125, 47.68359375, 48.12890625, 48.1171875, 49.7578125, 
            50.25, 48.94921875, 47.19140625, 47.84765625, 47.66015625, 44.66015625, 42.9375, 41.9296875, 44.80078125, 43.32421875, 
            42.1171875, 41.91796875, 40.453125, 40.359375, 39.85546875, 38.5546875, 39.4453125, 39.9375, 41.54296875, 42.3046875, 
            40.86328125, 44.14453125, 49.546875, 52.55859375, 52.21875, 49.7109375, 45.2578125, 48.83203125, 48.328125, 42.5390625, 
            46.8515625, 47.6953125, 47.98828125, 46.98046875, 40.98046875, 40.0078125, 42.140625, 42.85546875, 43.04296875, 
            42.5625, 43.21875, 41.91796875, 44.05078125, 44.8359375, 44.37890625, 44.390625, 43.359375, 41.61328125, 42.8671875, 
            49.7578125, 51.76171875, 49.7109375, 46.34765625, 47.3671875, 46.67578125, 45.24609375, 44.578125, 41.44921875, 
            40.95703125, 41.953125, 42.17578125, 44.296875, 41.0625, 38.2265625, 40.546875, 40.18359375, 42.80859375, 40.4765625, 
            41.2265625, 41.09765625, 41.77734375, 43.18359375, 40.125, 33.12890625, 37.37109375, 37.98046875, 38.7890625, 
            38.66015625, 36.7734375, 36.1171875, 39.01171875, 37.875, 41.82421875, 40.06640625, 39.9375, 39.31640625, 38.51953125, 
            40.65234375, 41.2734375, 36.234375, 37.03125, 37.39453125, 41.14453125, 41.63671875, 39.26953125, 37.7578125, 
            33.69140625, 34.7109375, 36.4453125, 36.7265625, 36.84375, 36.36328125, 37.41796875, 37.91015625, 38.578125, 38.90625, 
            39.10546875, 38.953125, 39.10546875, 37.55859375, 37.74609375, 35.484375, 33.83203125, 36.10546875, 36.890625, 
            35.75390625, 34.25390625, 36.5390625, 38.14453125, 38.484375, 40.69921875, 40.7109375, 38.25, 36.97265625, 38.2265625, 
            36.3046875, 36.2109375, 34.78125, 36.65625, 35.7890625, 35.23828125, 35.68359375, 33.80859375, 36.4921875, 37.78125, 
            37.11328125, 35.12109375, 31.81640625, 32.71875, 34.171875, 34.37109375, 34.91015625, 38.6484375, 42.76171875, 43.0078125, 
            38.625, 35.91796875, 35.84765625, 41.61328125, 46.2890625
        ]
    }

    coeffs = load_coeffs('wide_lense')
    points, newp = project_points(data, coeffs, newmtx=True)

    dummy = np.zeros((1200,1600,3), dtype = np.uint8)

    plt.figure(figsize=(10, 6))
    plt.suptitle('Projection Visualization')
    plt.subplot(121)
    plt.title('Projected with mtx')
    plt.imshow(dummy)
    plt.scatter(points[0, :], points[1, :], c = points[2, :], cmap = 'viridis', vmin = 0, vmax = 10)
    plt.subplot(122)
    plt.title('Projected with newmtx')
    plt.imshow(dummy)
    plt.scatter(newp[0, :], newp[1, :], c = newp[2, :], cmap = 'viridis', vmin = 0, vmax = 10)
    cbar = plt.colorbar(shrink = 0.6)
    cbar.ax.set_ylabel('Z in [m]', rotation = 90)
    plt.show()